<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>qezu - ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¸¦åˆ—å®Ÿè¡Œ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .content {
      padding: 40px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    textarea, input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    textarea:focus, input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      min-height: 150px;
      resize: vertical;
      font-family: 'Monaco', 'Courier New', monospace;
    }

    .checkbox-group {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-item input[type="checkbox"] {
      width: auto;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 18px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .results {
      margin-top: 40px;
      display: none;
    }

    .results.show {
      display: block;
    }

    .result-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }

    .result-card.success {
      border-left-color: #28a745;
    }

    .result-card.error {
      border-left-color: #dc3545;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .agent-name {
      font-weight: 700;
      font-size: 1.2em;
      text-transform: uppercase;
    }

    .execution-time {
      color: #666;
      font-size: 0.9em;
    }

    .result-content {
      background: white;
      padding: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
    }

    .summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .summary h3 {
      margin-bottom: 10px;
    }

    .summary-stats {
      display: flex;
      gap: 30px;
      margin-top: 15px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 2em;
      font-weight: 700;
    }

    .stat-label {
      font-size: 0.9em;
      opacity: 0.9;
    }

    .loading {
      text-align: center;
      padding: 40px;
      display: none;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .aggregated-result {
      background: #e8f5e9;
      border: 2px solid #4caf50;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .aggregated-result h3 {
      color: #2e7d32;
      margin-bottom: 15px;
    }

    .aggregated-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 14px;
      max-height: 500px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸš€ qezu</h1>
      <p>ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¸¦åˆ—å®Ÿè¡Œã‚·ã‚¹ãƒ†ãƒ </p>
    </div>

    <div class="content">
      <form id="executeForm">
        <div class="form-group">
          <label for="prompt">æŒ‡ç¤ºãƒ»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ *</label>
          <textarea
            id="prompt"
            name="prompt"
            placeholder="ä¾‹: TypeScriptã§é…åˆ—ã‚’æ“ä½œã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„"
            required
          ></textarea>
        </div>

        <div class="form-group">
          <label for="taskType">ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—</label>
          <select id="taskType" name="taskType">
            <option value="general">ä¸€èˆ¬</option>
            <option value="code-generation">ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</option>
            <option value="code-completion">ã‚³ãƒ¼ãƒ‰è£œå®Œ</option>
            <option value="chat">ãƒãƒ£ãƒƒãƒˆ</option>
            <option value="slide">ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆ</option>
          </select>
        </div>

        <div class="form-group">
          <label for="language">è¨€èªï¼ˆã‚³ãƒ¼ãƒ‰ç”Ÿæˆã®å ´åˆï¼‰</label>
          <input
            type="text"
            id="language"
            name="language"
            placeholder="ä¾‹: typescript, python, javascript"
          />
        </div>

        <div class="form-group">
          <label>å®Ÿè¡Œã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</label>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="agent-codex" name="agents" value="codex" checked>
              <label for="agent-codex">Codex</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="agent-claude" name="agents" value="claude" checked>
              <label for="agent-claude">Claude</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="agent-gemini" name="agents" value="gemini" checked>
              <label for="agent-gemini">Gemini</label>
            </div>
          </div>
        </div>

        <button type="submit" id="executeBtn">å®Ÿè¡Œ</button>
      </form>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œä¸­...</p>
      </div>

      <div class="results" id="results">
        <div class="summary" id="summary"></div>
        <div id="resultCards"></div>
        <div class="aggregated-result" id="aggregatedResult"></div>
        <div class="slide-viewer" id="slideViewer" style="display: none;">
          <div class="slide-viewer-header">
            <h3>ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
            <div class="slide-viewer-controls">
              <button onclick="openSlideInNewWindow()" class="control-btn">æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã</button>
              <button onclick="downloadSlideHTML()" class="control-btn">HTMLãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
          </div>
          <iframe id="slideFrame" style="width: 100%; height: 600px; border: 2px solid #e0e0e0; border-radius: 8px; background: white;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000';
    let slideDeckData = null;
    let slideViewerShown = false;

    document.getElementById('executeForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const prompt = formData.get('prompt');
      const taskType = formData.get('taskType');
      const language = formData.get('language');
      const agents = formData.getAll('agents');

      const loading = document.getElementById('loading');
      const results = document.getElementById('results');
      const executeBtn = document.getElementById('executeBtn');
      const resultCardsDiv = document.getElementById('resultCards');
      const summaryDiv = document.getElementById('summary');
      const aggregatedDiv = document.getElementById('aggregatedResult');

      // çµæœã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
      resultCardsDiv.innerHTML = '';
      summaryDiv.innerHTML = '';
      aggregatedDiv.innerHTML = '';
      slideDeckData = null;
      slideViewerShown = false;
      
      // ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’éè¡¨ç¤º
      const slideViewer = document.getElementById('slideViewer');
      if (slideViewer) {
        slideViewer.style.display = 'none';
      }

      loading.classList.add('show');
      results.classList.remove('show');
      executeBtn.disabled = true;

      // é€²æ—è¡¨ç¤ºç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠ
      const progressContainer = document.createElement('div');
      progressContainer.id = 'progressContainer';
      progressContainer.style.cssText = 'margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; max-height: 400px; overflow-y: auto; border: 2px solid #e0e0e0;';
      const progressTitle = document.createElement('h3');
      progressTitle.textContent = 'å®Ÿè¡Œé€²æ—';
      progressTitle.style.cssText = 'margin: 0 0 15px 0; color: #333; font-size: 18px;';
      progressContainer.appendChild(progressTitle);
      loading.appendChild(progressContainer);

      const agentResults = [];
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
      slideDeckData = null;
      slideViewerShown = false;

      try {
        // SSEã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å®Ÿè¡Œ
        const response = await fetch(`${API_URL}/api/execute/stream`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            prompt,
            taskType,
            language: language || undefined,
            agents: agents.length > 0 ? agents : undefined,
          }),
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) {
            console.log('[Client] SSEã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒçµ‚äº†ã—ã¾ã—ãŸ');
            break;
          }

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';

          let currentEvent = '';
          for (const line of lines) {
            if (line.startsWith('event: ')) {
              currentEvent = line.substring(7).trim();
              // endã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã¯ã‚¹ãƒˆãƒªãƒ¼ãƒ çµ‚äº†
              if (currentEvent === 'end') {
                console.log('[Client] endã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ã—ã¾ã—ãŸ');
                break;
              }
              continue;
            }
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.substring(6));
                handleSSEEvent(data, progressContainer, agentResults, currentEvent);
              } catch (e) {
                console.error('[Client] ãƒ‡ãƒ¼ã‚¿ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
              }
            }
          }
        }

        // æœ€çµ‚çµæœã‚’è¡¨ç¤ºï¼ˆagentResultsã‹ã‚‰æ§‹ç¯‰ï¼‰
        if (agentResults.length > 0) {
          const successfulResults = agentResults.filter(r => r.success && r.result);
          displayResults({
            success: true,
            results: agentResults,
            aggregated: successfulResults.map(r => `## ${r.agent.toUpperCase()}\n\n${r.result}`).join('\n\n---\n\n'),
            summary: {
              total: agentResults.length,
              success: successfulResults.length,
              failed: agentResults.length - successfulResults.length,
              averageTime: agentResults.reduce((sum, r) => sum + (r.executionTime || 0), 0) / agentResults.length || 0,
              totalExecutionTime: agentResults.reduce((sum, r) => sum + (r.executionTime || 0), 0),
            },
            slideDeck: slideDeckData,
          });
        } else {
          // çµæœãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆ
          alert('ã‚¨ãƒ©ãƒ¼: çµæœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        }

        progressContainer.remove();
        loading.classList.remove('show');
        results.classList.add('show');
      } catch (error) {
        alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        progressContainer.remove();
        loading.classList.remove('show');
      } finally {
        executeBtn.disabled = false;
      }
    });

    let currentSlideDeck = null;
    let slideUpdateTimeout = null;

    function handleSSEEvent(data, container, agentResults, eventType) {
      // å€‹åˆ¥ã‚¹ãƒ©ã‚¤ãƒ‰ã®é€²æ—ã‚¤ãƒ™ãƒ³ãƒˆ
      if (eventType === 'slide-progress') {
        const slideProgressId = `slide-progress-${data.slideNumber}`;
        let progressDiv = document.getElementById(slideProgressId);
        
        if (!progressDiv) {
          progressDiv = document.createElement('div');
          progressDiv.id = slideProgressId;
          progressDiv.style.cssText = 'padding: 8px; margin: 3px 0; background: #f0f7ff; border-radius: 4px; border-left: 3px solid #2196f3; font-size: 13px;';
          const progressContainer = document.getElementById('progressContainer');
          if (progressContainer) {
            progressContainer.appendChild(progressDiv);
          }
        }
        
        const statusEmoji = data.status === 'generating' ? 'ğŸ”„' : data.status === 'processing' ? 'âš™ï¸' : 'âœ¨';
        progressDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 16px;">${statusEmoji}</span>
            <div style="flex: 1;">
              <strong style="color: #1976d2;">ã‚¹ãƒ©ã‚¤ãƒ‰${data.slideNumber}</strong>
              <span style="margin-left: 10px; font-size: 12px; color: #666;">${data.agent || 'codex'}</span>
              <div style="margin-top: 4px; width: 100%; background: #e0e0e0; border-radius: 4px; height: 6px;">
                <div style="width: ${data.progress}%; background: #2196f3; height: 100%; border-radius: 4px; transition: width 0.2s;"></div>
              </div>
            </div>
          </div>
        `;
        
        const progressContainer = document.getElementById('progressContainer');
        if (progressContainer) {
          progressContainer.scrollTop = progressContainer.scrollHeight;
        }
        return;
      }
      
      // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å‡¦ç†ï¼ˆæ–‡å­—å˜ä½ï¼‰
      if (eventType === 'slide-stream') {
        if (data.slideDeck) {
          currentSlideDeck = data.slideDeck;
          slideDeckData = data.slideDeck;
          
          // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¡¨ç¤º
          if (!slideViewerShown) {
            const slideViewer = document.getElementById('slideViewer');
            const results = document.getElementById('results');
            if (slideViewer && results) {
              slideViewer.style.display = 'block';
              slideViewerShown = true;
              results.classList.add('show');
            }
          }
          
          // ä¸¦åˆ—ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆã®å ´åˆã¯å³åº§ã«æ›´æ–°
          if (data.slideNumber !== undefined) {
            // 1ã‚¹ãƒ©ã‚¤ãƒ‰ãšã¤è¿½åŠ ã•ã‚Œã‚‹ä¸¦åˆ—ç”Ÿæˆ
            displaySlide(data.slideDeck);
            
            // æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ãŒå®Œæˆã—ãŸå ´åˆã®è¡¨ç¤º
            if (data.isNewSlide) {
              const slideProgressId = `slide-progress-${data.slideNumber}`;
              const progressDiv = document.getElementById(slideProgressId);
              if (progressDiv) {
                progressDiv.style.borderLeftColor = '#4caf50';
                progressDiv.innerHTML = `
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 16px;">âœ…</span>
                    <div style="flex: 1;">
                      <strong style="color: #2e7d32;">ã‚¹ãƒ©ã‚¤ãƒ‰${data.slideNumber} å®Œæˆ</strong>
                      <span style="margin-left: 10px; font-size: 12px; color: #666;">${data.agent || 'codex'}</span>
                      <div style="margin-top: 4px; width: 100%; background: #e0e0e0; border-radius: 4px; height: 6px;">
                        <div style="width: 100%; background: #4caf50; height: 100%; border-radius: 4px;"></div>
                      </div>
                    </div>
                  </div>
                `;
              }
            }
            
            // å…¨ä½“ã®é€²æ—ã‚’è¡¨ç¤º
            if (data.completedSlides !== undefined && data.totalSlides !== undefined) {
              const overallProgressId = 'overall-progress';
              let overallDiv = document.getElementById(overallProgressId);
              
              if (!overallDiv) {
                overallDiv = document.createElement('div');
                overallDiv.id = overallProgressId;
                overallDiv.style.cssText = 'padding: 12px; margin: 10px 0; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3; font-size: 14px;';
                const progressContainer = document.getElementById('progressContainer');
                if (progressContainer) {
                  progressContainer.insertBefore(overallDiv, progressContainer.firstChild);
                }
              }
              
              const percentage = Math.round((data.completedSlides / data.totalSlides) * 100);
              overallDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 20px;">ğŸ“Š</span>
                  <div style="flex: 1;">
                    <strong style="color: #1976d2;">å…¨ä½“é€²æ—: ${data.completedSlides} / ${data.totalSlides} æšå®Œäº† (${percentage}%)</strong>
                    <div style="margin-top: 6px; width: 100%; background: #e0e0e0; border-radius: 4px; height: 10px;">
                      <div style="width: ${percentage}%; background: #2196f3; height: 100%; border-radius: 4px; transition: width 0.3s;"></div>
                    </div>
                  </div>
                </div>
              `;
            }
          } else {
            // é€šå¸¸ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
            const isNewSlide = data.newSlideCount && data.newSlideCount > data.previousSlideCount;
            if (isNewSlide) {
              // æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã¯å³åº§ã«æ›´æ–°
              displaySlide(data.slideDeck);
            } else {
              // ãã‚Œä»¥å¤–ã¯ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ï¼ˆ50msã”ã¨ã«æ›´æ–°ï¼‰
              if (slideUpdateTimeout) {
                clearTimeout(slideUpdateTimeout);
              }
              slideUpdateTimeout = setTimeout(() => {
                displaySlide(data.slideDeck);
              }, 50);
            }
          }
        }
        return;
      }
      
      // ã‚¹ãƒ©ã‚¤ãƒ‰å®Œæˆã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
      if (eventType === 'slide-complete') {
        if (data.slideDeck) {
          slideDeckData = data.slideDeck;
          displaySlide(data.slideDeck);
          
          // é€²æ—ã«å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          const messageDiv = document.createElement('div');
          messageDiv.style.cssText = 'padding: 10px; margin: 5px 0; background: #e8f5e9; border-radius: 4px; border-left: 3px solid #4caf50; font-size: 14px;';
          messageDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 18px;">âœ…</span>
              <div>
                <strong style="color: #2e7d32;">ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆå®Œäº†</strong>
                <span style="margin-left: 10px;">${data.totalSlides || data.slideDeck.slides.length}æšã®ã‚¹ãƒ©ã‚¤ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ</span>
              </div>
            </div>
          `;
          container.appendChild(messageDiv);
          container.scrollTop = container.scrollHeight;
        }
        return;
      }
      
      // ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å‡¦ç†
      if (eventType === 'slide-generated') {
        if (data.slideDeck) {
          slideDeckData = data.slideDeck;
          // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¡¨ç¤º
          if (!slideViewerShown) {
            const slideViewer = document.getElementById('slideViewer');
            const results = document.getElementById('results');
            if (slideViewer && results) {
              slideViewer.style.display = 'block';
              slideViewerShown = true;
              results.classList.add('show');
              displaySlide(data.slideDeck);
            }
          } else {
            // æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ›´æ–°
            displaySlide(data.slideDeck);
          }
          
          // é€²æ—ã«ã‚‚è¡¨ç¤º
          const messageDiv = document.createElement('div');
          messageDiv.style.cssText = 'padding: 10px; margin: 5px 0; background: #e8f5e9; border-radius: 4px; border-left: 3px solid #4caf50; font-size: 14px;';
          messageDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 18px;">ğŸ“Š</span>
              <div>
                <strong style="color: #2e7d32;">ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆå®Œäº†</strong>
                <span style="margin-left: 10px;">${data.agent ? data.agent.toUpperCase() : ''}ã‹ã‚‰${data.slideDeck.slides.length}æšã®ã‚¹ãƒ©ã‚¤ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ</span>
              </div>
            </div>
          `;
          container.appendChild(messageDiv);
          container.scrollTop = container.scrollHeight;
        }
        return;
      }
      
      if (eventType === 'complete' || eventType === 'final' || eventType === 'end') {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
        const loading = document.querySelector('.loading');
        if (loading) {
          loading.classList.remove('show');
        }
        
        // ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        if (data.slideDeck) {
          slideDeckData = data.slideDeck;
        }
        
        // complete/finalã‚¤ãƒ™ãƒ³ãƒˆã§å…¨çµæœã‚’å—ã‘å–ã‚‹
        if (data.results && Array.isArray(data.results)) {
          data.results.forEach(result => {
            const existingIndex = agentResults.findIndex(r => r.agent === result.agent);
            if (existingIndex >= 0) {
              agentResults[existingIndex] = result;
            } else {
              agentResults.push(result);
            }
          });
        }
        return;
      }

      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = 'padding: 10px; margin: 5px 0; background: white; border-radius: 4px; border-left: 3px solid #667eea; font-size: 14px;';
      
      if (data.agent) {
        // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå›ºæœ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const color = data.error ? '#dc3545' : '#28a745';
        messageDiv.style.borderLeftColor = color;
        const icon = data.error ? 'âŒ' : 'âœ…';
        const status = data.error ? 'ã‚¨ãƒ©ãƒ¼' : 'å®Œäº†';
        messageDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 18px;">${icon}</span>
            <div style="flex: 1;">
              <strong style="color: ${color};">${data.agent.toUpperCase()}</strong>
              <span style="color: #666; margin-left: 10px;">${status}</span>
              ${data.executionTime ? `<span style="color: #999; margin-left: 10px;">(${data.executionTime}ms)</span>` : ''}
            </div>
          </div>
          ${data.message ? `<div style="margin-top: 5px; color: #555;">${escapeHtml(data.message)}</div>` : ''}
          ${data.error ? `<div style="margin-top: 5px; color: #dc3545; font-family: monospace; font-size: 12px;">${escapeHtml(data.error)}</div>` : ''}
          ${data.result ? `<div style="margin-top: 5px; color: #555; font-family: monospace; font-size: 12px; max-height: 100px; overflow-y: auto;">${escapeHtml(data.result)}</div>` : ''}
        `;
      } else if (data.message) {
        // ä¸€èˆ¬çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        messageDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 18px;">ğŸ”„</span>
            <div>
              <strong>${new Date().toLocaleTimeString()}</strong>
              <span style="margin-left: 10px;">${escapeHtml(data.message)}</span>
            </div>
          </div>
        `;
      }

      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }

    function displayResults(data) {
      const summaryDiv = document.getElementById('summary');
      const resultCardsDiv = document.getElementById('resultCards');
      const aggregatedDiv = document.getElementById('aggregatedResult');
      const results = document.getElementById('results');

      // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
      summaryDiv.innerHTML = `
        <h3>å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼</h3>
        <div class="summary-stats">
          <div class="stat-item">
            <div class="stat-value">${data.summary.success}</div>
            <div class="stat-label">æˆåŠŸ</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${data.summary.failed}</div>
            <div class="stat-label">å¤±æ•—</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${Math.round(data.summary.averageTime)}ms</div>
            <div class="stat-label">å¹³å‡å®Ÿè¡Œæ™‚é–“</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${Math.round(data.summary.totalExecutionTime)}ms</div>
            <div class="stat-label">åˆè¨ˆå®Ÿè¡Œæ™‚é–“</div>
          </div>
        </div>
      `;

      // å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®çµæœè¡¨ç¤º
      resultCardsDiv.innerHTML = data.results.map(result => `
        <div class="result-card ${result.success ? 'success' : 'error'}">
          <div class="result-header">
            <span class="agent-name">${result.agent}</span>
            <span class="execution-time">${result.executionTime}ms</span>
          </div>
          <div class="result-content">
            ${result.success ? escapeHtml(result.result || '') : escapeHtml(result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')}
          </div>
        </div>
      `).join('');

      // çµ±åˆçµæœè¡¨ç¤º
      if (data.aggregated) {
        aggregatedDiv.innerHTML = `
          <h3>çµ±åˆçµæœ</h3>
          <div class="aggregated-content">${escapeHtml(data.aggregated)}</div>
        `;
      }

      // ã‚¹ãƒ©ã‚¤ãƒ‰è¡¨ç¤ºï¼ˆæ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ›´æ–°ã—ãªã„ï¼‰
      const slideViewer = document.getElementById('slideViewer');
      if (data.slideDeck && slideViewer && !slideViewerShown) {
        displaySlide(data.slideDeck);
        slideViewer.style.display = 'block';
        slideViewerShown = true;
      } else if (slideViewer && !data.slideDeck) {
        slideViewer.style.display = 'none';
        slideViewerShown = false;
      }

      results.classList.add('show');
    }

    let previousSlideCount = 0;
    
    function displaySlide(slideDeck) {
      if (!slideDeck || !slideDeck.slides) return;
      
      const currentSlideCount = slideDeck.slides.length;
      const isNewSlide = currentSlideCount > previousSlideCount;
      previousSlideCount = currentSlideCount;
      
      // ã‚¹ãƒ©ã‚¤ãƒ‰HTMLã‚’ç”Ÿæˆï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰
      fetch(`${API_URL}/api/slides/generate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ slideDeck }),
      })
      .then(response => response.text())
      .then(html => {
        const frame = document.getElementById('slideFrame');
        
        // æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœã‚’è¿½åŠ 
        if (isNewSlide && frame.contentWindow) {
          // ã‚¹ãƒ©ã‚¤ãƒ‰ãŒè¿½åŠ ã•ã‚ŒãŸã“ã¨ã‚’é€šçŸ¥
          frame.contentWindow.postMessage({
            type: 'newSlide',
            slideCount: currentSlideCount
          }, '*');
        }
        
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        
        // æ—¢å­˜ã®Blob URLã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if (window.slideBlobUrl) {
          URL.revokeObjectURL(window.slideBlobUrl);
        }
        
        frame.src = url;
        window.slideBlobUrl = url; // å¾Œã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç”¨
        
        // ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦æœ€æ–°ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¡¨ç¤º
        setTimeout(() => {
          if (frame.contentWindow) {
            frame.contentWindow.scrollTo({
              left: (currentSlideCount - 1) * frame.contentWindow.innerWidth,
              behavior: 'smooth'
            });
          }
        }, 100);
      })
      .catch(error => {
        console.error('ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¹ãƒ©ã‚¤ãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    function openSlideInNewWindow() {
      const frame = document.getElementById('slideFrame');
      if (frame && frame.src) {
        window.open(frame.src, '_blank');
      }
    }

    function downloadSlideHTML() {
      const frame = document.getElementById('slideFrame');
      if (frame && frame.contentWindow) {
        frame.contentWindow.postMessage('download', '*');
      } else {
        fetch(`${API_URL}/api/slides/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ slideDeck: slideDeckData }),
        })
        .then(response => response.text())
        .then(html => {
          const blob = new Blob([html], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'slides.html';
          a.click();
          URL.revokeObjectURL(url);
        });
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>

